name: Test Latest Release Configs
on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  checks: write
  pull-requests: write

jobs:
  # Test basic coverage with new text-instead-badge option
  test-text-badge:
    name: Test Text Instead of Badge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Coverage with text badge
        id: textBadge
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_1.txt
          junitxml-path: ./data/pytest_1.xml
          text-instead-badge: true
          title: 'Coverage with Text Badge'

      - name: Verify outputs
        run: |
          echo "Coverage: ${{ steps.textBadge.outputs.coverage }}"
          echo "Color: ${{ steps.textBadge.outputs.color }}"
          echo "Tests: ${{ steps.textBadge.outputs.tests }}"

  # Test XML coverage with skip-covered option
  test-xml-skip-covered:
    name: Test XML Skip 100% Covered Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Coverage skip covered files
        id: xmlSkipCovered
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-xml-coverage-path: ./data/coverage_1.xml
          xml-skip-covered: true
          title: 'XML Coverage (Hide 100% Files)'
          create-new-comment: true

      - name: Verify outputs
        run: |
          echo "Coverage: ${{ steps.xmlSkipCovered.outputs.coverage }}"
          echo "Coverage HTML: ${{ steps.xmlSkipCovered.outputs.coverageHtml }}"

  # Test report-only-changed-files option
  test-changed-files-only:
    name: Test Show Only Changed Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Coverage for changed files only
        id: changedFiles
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_2.txt
          report-only-changed-files: true
          title: 'Coverage for Changed Files'
          create-new-comment: true

      - name: Verify outputs
        run: |
          echo "Coverage: ${{ steps.changedFiles.outputs.coverage }}"

  # Test badge customization options
  test-badge-customization:
    name: Test Badge Customization
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Custom badge title
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_3.txt
          badge-title: 'Test Coverage'
          title: 'Custom Badge Title'
          create-new-comment: true

      - name: Remove badge link
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_4.txt
          remove-link-from-badge: true
          title: 'Badge Without Link'
          create-new-comment: true

      - name: Hide badge entirely
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_5.txt
          hide-badge: true
          title: 'No Badge'
          create-new-comment: true

  # Test link removal options for large reports
  test-link-removal:
    name: Test Link Removal Options
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Remove file links
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_6.txt
          remove-links-to-files: true
          title: 'No File Links'
          create-new-comment: true

      - name: Remove line links
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_7.txt
          remove-links-to-lines: true
          title: 'No Line Links'
          create-new-comment: true

      - name: Remove all links
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_8.txt
          remove-links-to-files: true
          remove-links-to-lines: true
          title: 'No Links at All'
          create-new-comment: true

  # Test hide options
  test-hide-options:
    name: Test Hide Report Options
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Hide detailed report
        id: hideReport
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_9.txt
          junitxml-path: ./data/pytest_2.xml
          hide-report: true
          title: 'Summary Only'
          create-new-comment: true

      - name: Use outputs only (no comment)
        id: outputsOnly
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_10.txt
          hide-comment: true

      - name: Verify outputs from hidden comment
        run: |
          echo "Coverage from hidden: ${{ steps.outputsOnly.outputs.coverage }}"
          echo "Color: ${{ steps.outputsOnly.outputs.color }}"

  # Test multiple files with various options
  test-multiple-files-advanced:
    name: Test Multiple Files Advanced
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Multiple files with text badges
        uses: MishaKav/pytest-coverage-comment@main
        with:
          text-instead-badge: true
          create-new-comment: true
          multiple-files: |
            Backend API, ./data/pytest-coverage_1.txt, ./data/pytest_1.xml
            Frontend App, ./data/pytest-coverage_2.txt, ./data/pytest_2.xml
            Data Layer, ./data/pytest-coverage_3.txt

      - name: Multiple files with custom badges
        uses: MishaKav/pytest-coverage-comment@main
        with:
          badge-title: 'Cov'
          create-new-comment: true
          multiple-files: |
            Service A, ./data/pytest-coverage_4.txt
            Service B, ./data/pytest-coverage_5.txt

  # Test coverage path prefix for monorepos
  test-path-prefix:
    name: Test Coverage Path Prefix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Coverage with path prefix
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_11.txt
          coverage-path-prefix: 'backend/'
          title: 'Backend Coverage'
          create-new-comment: true

  # Test unique ID for matrix builds
  test-unique-id-matrix:
    name: Test Matrix Builds with Unique IDs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        test-suite: ['unit', 'integration']
    steps:
      - uses: actions/checkout@v5

      - name: Coverage for matrix build
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_12.txt
          junitxml-path: ./data/pytest_3.xml
          title: 'Coverage Python ${{ matrix.python-version }} - ${{ matrix.test-suite }}'
          unique-id-for-comment: 'py${{ matrix.python-version }}-${{ matrix.test-suite }}'
          create-new-comment: true

  # Test JUnit XML features
  test-junit-features:
    name: Test JUnit XML Features
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: JUnit with custom title
        id: junitTest
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_1.txt
          junitxml-path: ./data/pytest_1.xml
          junitxml-title: 'Test Results Summary'
          create-new-comment: true

      - name: Verify JUnit outputs
        run: |
          echo "Tests: ${{ steps.junitTest.outputs.tests }}"
          echo "Failures: ${{ steps.junitTest.outputs.failures }}"
          echo "Errors: ${{ steps.junitTest.outputs.errors }}"
          echo "Skipped: ${{ steps.junitTest.outputs.skipped }}"
          echo "Time: ${{ steps.junitTest.outputs.time }}"
          echo "Failed test info: ${{ steps.junitTest.outputs.notSuccessTestInfo }}"

  # Test default branch customization
  test-default-branch:
    name: Test Default Branch Option
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Coverage with custom default branch
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_2.txt
          default-branch: 'develop'
          title: 'Coverage (develop branch links)'
          create-new-comment: true

  # Combined test with multiple options
  test-kitchen-sink:
    name: Test Kitchen Sink Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: All options combined
        id: kitchenSink
        uses: MishaKav/pytest-coverage-comment@main
        with:
          pytest-coverage-path: ./data/pytest-coverage_1.txt
          pytest-xml-coverage-path: ./data/coverage_1.xml
          junitxml-path: ./data/pytest_1.xml
          text-instead-badge: true
          badge-title: 'Total Cov'
          title: 'Comprehensive Coverage Report'
          junitxml-title: 'All Tests'
          coverage-path-prefix: 'src/'
          default-branch: 'main'
          create-new-comment: true

      - name: Verify all outputs
        run: |
          echo "Coverage: ${{ steps.kitchenSink.outputs.coverage }}"
          echo "Color: ${{ steps.kitchenSink.outputs.color }}"
          echo "Warnings: ${{ steps.kitchenSink.outputs.warnings }}"
          echo "Tests: ${{ steps.kitchenSink.outputs.tests }}"
          echo "Failures: ${{ steps.kitchenSink.outputs.failures }}"
          echo "Errors: ${{ steps.kitchenSink.outputs.errors }}"
          echo "Skipped: ${{ steps.kitchenSink.outputs.skipped }}"
          echo "Time: ${{ steps.kitchenSink.outputs.time }}"
